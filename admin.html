<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ADMIN</title>
<style>
body { background:#000; color:#0f0; font-family: monospace; padding:20px; }
input, button { padding:10px; margin:5px 0; width:100%; background: #111; border: 1px solid #0f0; color: #0f0; }
button { cursor: pointer; }
table { width:100%; border-collapse:collapse; margin-top:20px; }
td, th { border:1px solid #0f0; padding:6px; text-align: left; }
.earn-block { border:1px solid #0f0; margin:10px 0; padding:10px; }
.earn-block input { width: 90%; margin-bottom: 5px; }
.earn-controls { display:flex; gap:5px; margin-top:5px; }
.save-btn { background: #0f0; color: #000; border: none; padding: 10px; cursor: pointer; margin-top: 10px; width:100%; }
</style>
</head>
<body>

<h2>ğŸ” ADMIN LOGIN</h2>
<input id="pass" type="password" placeholder="Password">
<button onclick="login()">LOGIN</button>

<div id="panel" style="display:none">
    <h2>ğŸ‘‘ USERS</h2>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Email</th>
                <th>Username</th>
                <th>Score</th>
            </tr>
        </thead>
        <tbody id="users"></tbody>
    </table>

    <button onclick="showEarnEditor()">ğŸ¯ Earn Editor</button>

    <div id="earn-editor" style="display:none; margin-top:20px;">
        <h2>ğŸ¯ Earn Blocks</h2>
        <div id="earn-blocks-container"></div>
        <button class="save-btn" onclick="saveEarnBlocks()">ğŸ’¾ Save All Changes</button>
    </div>
</div>

<script>
const ADMIN_PASSWORD = "dandelion0514";
const MAX_BLOCKS = 35;
let earnBlocks = Array(MAX_BLOCKS).fill(null);

function login() {
    const password = document.getElementById("pass").value;
    if(password !== ADMIN_PASSWORD) {
        alert("WRONG PASSWORD");
        return;
    }
    document.getElementById("panel").style.display = "block";
    loadUsers();
    loadEarnBlocks();
}

function loadUsers() {
    fetch("/admin/users", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password: ADMIN_PASSWORD })
    })
    .then(res => res.json())
    .then(data => {
        const tbody = document.getElementById("users");
        tbody.innerHTML = "";
        data.forEach(u => {
            tbody.innerHTML += `
                <tr>
                    <td>${u.id}</td>
                    <td>${u.email}</td>
                    <td>${u.username}</td>
                    <td>${u.score || 0}</td>
                </tr>
            `;
        });
    })
    .catch(err => console.error(err));
}

// ==================== Earn Editor ====================

function showEarnEditor() {
    document.getElementById("earn-editor").style.display = "block";
    renderEarnBlocks();
}

function renderEarnBlocks() {
    const container = document.getElementById("earn-blocks-container");
    container.innerHTML = "";

    earnBlocks.forEach((block, index) => {
        if(!block) block = {};
        const blockEl = document.createElement("div");
        blockEl.className = "earn-block";

        blockEl.innerHTML = `
            <h3>Block ${index+1}</h3>
            <label>Title: <input type="text" value="${block.title || ''}" onchange="updateBlock(${index}, 'title', this.value)"></label><br>
            <label>Reward (score): <input type="number" value="${block.reward || ''}" onchange="updateBlock(${index}, 'reward', Number(this.value))"></label><br>
            <label>Icon/Emoji: <input type="text" value="${block.icon || ''}" onchange="updateBlock(${index}, 'icon', this.value)"></label><br>
            <label>Link: <input type="text" value="${block.link || ''}" onchange="updateBlock(${index}, 'link', this.value)"></label><br>
            <div class="earn-controls">
                <button onclick="moveBlockLeft(${index})">â† Left</button>
                <button onclick="moveBlockRight(${index})">Right â†’</button>
            </div>
        `;

        container.appendChild(blockEl);
    });
}

function updateBlock(index, key, value) {
    if (!earnBlocks[index]) earnBlocks[index] = {};
    earnBlocks[index][key] = value;
}

// Ğ“Ğ¾Ñ€Ñ‚Ğ°Ğ½Ğ½Ñ Ğ±Ğ»Ğ¾ĞºÑ–Ğ²
function moveBlockLeft(index) {
    if (index === 0) return;
    [earnBlocks[index-1], earnBlocks[index]] = [earnBlocks[index], earnBlocks[index-1]];
    renderEarnBlocks();
}

function moveBlockRight(index) {
    if (index === MAX_BLOCKS-1) return;
    [earnBlocks[index+1], earnBlocks[index]] = [earnBlocks[index], earnBlocks[index+1]];
    renderEarnBlocks();
}

// ==================== Ğ—Ğ±ĞµÑ€ĞµĞ¶ĞµĞ½Ğ½Ñ ====================

function saveEarnBlocks() {
    fetch("/admin/earn-blocks", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password: ADMIN_PASSWORD, blocks: earnBlocks })
    })
    .then(res => {
        if(res.ok) alert("âœ… Blocks saved successfully!");
        else alert("âŒ Error saving blocks");
    })
    .catch(err => console.error(err));
}

// Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ±Ğ»Ğ¾ĞºÑ–Ğ² Ğ· ÑĞµÑ€Ğ²ĞµÑ€Ğ°
function loadEarnBlocks() {
    fetch("/earn-blocks")
    .then(res => res.json())
    .then(data => {
        earnBlocks = Array(MAX_BLOCKS).fill(null);
        if(Array.isArray(data)){
            for(let i=0;i<data.length;i++){
                earnBlocks[i] = data[i] || {};
            }
        }
        renderEarnBlocks();
    })
    .catch(err => console.error(err));
}
</script>

</body>
</html>