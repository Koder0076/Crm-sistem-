<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ADMIN</title>

<style>
body {
    background:#000;
    color:#0f0;
    font-family: monospace;
    padding:20px;
}

input, button {
    padding:10px;
    margin:5px 0;
    width:100%;
    background:#111;
    border:1px solid #0f0;
    color:#0f0;
}

button {
    cursor:pointer;
}

table {
    width:100%;
    border-collapse:collapse;
    margin-top:20px;
}

td, th {
    border:1px solid #0f0;
    padding:6px;
    text-align:left;
}

.earn-block {
    border:1px solid #0f0;
    margin:10px 0;
    padding:10px;
}

.earn-block input {
    width:90%;
    margin-bottom:5px;
}

.earn-controls {
    display:flex;
    gap:5px;
    margin-top:5px;
}

.save-btn {
    background:#0f0;
    color:#000;
    border:none;
    padding:10px;
    cursor:pointer;
    margin-top:10px;
    width:100%;
}

.delete-btn {
    background:red;
    color:white;
    margin-top:20px;
    border:none;
}
</style>
</head>

<body>

<h2>üîê ADMIN LOGIN</h2>
<input id="pass" type="password" placeholder="Password">
<button onclick="login()">LOGIN</button>

<div id="panel" style="display:none">

    <h2>üëë USERS</h2>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Email</th>
                <th>Username</th>
                <th>Score</th>
            </tr>
        </thead>
        <tbody id="users"></tbody>
    </table>

    <button onclick="showEarnEditor()">üéØ Earn Editor</button>

    <div id="earn-editor" style="display:none; margin-top:20px;">
        <h2>üéØ Earn Blocks</h2>
        <div id="earn-blocks-container"></div>
        <button class="save-btn" onclick="saveEarnBlocks()">üíæ Save All Changes</button>
    </div>

    <button class="delete-btn" onclick="deleteAllData()">‚ùå DELETE ALL DATA</button>

</div>

<script>
const ADMIN_PASSWORD = "dandelion0514";
const MAX_BLOCKS = 35;

let earnBlocks = Array(MAX_BLOCKS).fill(null);

/* ===== LOGIN ===== */
function login() {
    const password = document.getElementById("pass").value;
    if (password !== ADMIN_PASSWORD) {
        alert("WRONG PASSWORD");
        return;
    }
    document.getElementById("panel").style.display = "block";
    loadUsers();
    loadEarnBlocks();
}

/* ===== USERS ===== */
function loadUsers() {
    fetch("/admin/users", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password: ADMIN_PASSWORD })
    })
    .then(res => res.json())
    .then(data => {
        const tbody = document.getElementById("users");
        tbody.innerHTML = "";
        data.forEach(u => {
            tbody.innerHTML += `
                <tr>
                    <td>${u.id}</td>
                    <td>${u.email}</td>
                    <td>${u.username}</td>
                    <td>${u.score || 0}</td>
                </tr>
            `;
        });
    })
    .catch(err => console.error(err));
}

/* ===== EARN EDITOR ===== */
function showEarnEditor() {
    document.getElementById("earn-editor").style.display = "block";
    renderEarnBlocks();
}

function renderEarnBlocks() {
    const container = document.getElementById("earn-blocks-container");
    container.innerHTML = "";

    earnBlocks.forEach((block, index) => {
        if (!block) block = {};

        const blockEl = document.createElement("div");
        blockEl.className = "earn-block";

        blockEl.innerHTML = `
            <h3>Block ${index + 1}</h3>

            <label>Title:
                <input type="text" value="${block.title || ""}"
                onchange="updateBlock(${index}, 'title', this.value)">
            </label><br>

            <label>Reward (score):
                <input type="number" value="${block.reward || ""}"
                onchange="updateBlock(${index}, 'reward', Number(this.value))">
            </label><br>

            <label>Icon image:
                <input type="file" accept="image/*"
                onchange="uploadIcon(event, ${index})">
            </label><br>

            ${block.icon ? `<img src="${block.icon}" style="width:32px;height:32px;object-fit:contain;margin-top:5px;">` : ""}

            <br>

            <label>Link:
                <input type="text" value="${block.link || ""}"
                onchange="updateBlock(${index}, 'link', this.value)">
            </label><br>

            <div class="earn-controls">
                <button onclick="moveBlockLeft(${index})">‚Üê Left</button>
                <button onclick="moveBlockRight(${index})">Right ‚Üí</button>
            </div>
        `;

        container.appendChild(blockEl);
    });
}

function updateBlock(index, key, value) {
    if (!earnBlocks[index]) earnBlocks[index] = {};
    earnBlocks[index][key] = value;
}

function uploadIcon(event, index) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
        if (!earnBlocks[index]) earnBlocks[index] = {};
        earnBlocks[index].icon = reader.result;
        renderEarnBlocks();
    };
    reader.readAsDataURL(file);
}

function moveBlockLeft(index) {
    if (index === 0) return;
    [earnBlocks[index - 1], earnBlocks[index]] =
    [earnBlocks[index], earnBlocks[index - 1]];
    renderEarnBlocks();
}

function moveBlockRight(index) {
    if (index === MAX_BLOCKS - 1) return;
    [earnBlocks[index + 1], earnBlocks[index]] =
    [earnBlocks[index], earnBlocks[index + 1]];
    renderEarnBlocks();
}

/* ===== SAVE BLOCKS ===== */
function saveEarnBlocks() {
    fetch("/admin/earn-blocks", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            password: ADMIN_PASSWORD,
            blocks: earnBlocks
        })
    })
    .then(res => {
        if (res.ok) alert("‚úÖ Blocks saved successfully!");
        else alert("‚ùå Error saving blocks");
    })
    .catch(err => console.error(err));
}

function loadEarnBlocks() {
    fetch("/earn-blocks")
    .then(res => res.json())
    .then(data => {
        earnBlocks = Array(MAX_BLOCKS).fill(null);
        if (Array.isArray(data)) {
            for (let i = 0; i < data.length; i++) {
                earnBlocks[i] = data[i] || {};
            }
        }
        renderEarnBlocks();
    })
    .catch(err => console.error(err));
}

/* ===== DELETE ALL DATA ===== */
function deleteAllData() {
    const pass = prompt("Enter admin password to DELETE EVERYTHING:");
    if (pass !== ADMIN_PASSWORD) {
        alert("WRONG PASSWORD");
        return;
    }

    if (!confirm("‚ö†Ô∏è THIS WILL DELETE ALL DATA FOREVER. CONTINUE?")) return;

    fetch("/admin/delete-all", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password: ADMIN_PASSWORD })
    })
    .then(res => res.json())
    .then(data => {
        if (data.ok) {
            alert("üî• ALL DATA DELETED");
            location.reload();
        } else {
            alert("ERROR");
        }
    })
    .catch(err => console.error(err));
}
</script>

</body>
</html>