<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Notcoin Tasks UI</title>
<link rel="stylesheet" href="style2.css">

<style>
.task-section { margin-bottom: 30px; }
.task-card.completed .task-text p { color: gray; }
.task-info { display: flex; align-items: center; }
.task-icon { width:40px; text-align:center; }
.task-icon-img { width:30px; height:30px; object-fit:contain; }
.arrow, .check { font-size:20px; margin-left:10px; }
</style>
</head>

<body>
<div class="app-container">
<section class="task-section">
<h2 class="section-title">Earn</h2>
<div id="earn-container"></div>
</section>
</div>

<script>
let earnBlocks = [];
const earnContainer = document.getElementById("earn-container");
const uid = localStorage.getItem("uid");

fetch("/earn-blocks")
.then(res => res.json())
.then(data => {
    earnBlocks = data.slice(0, 35);
    renderBlocks();
});

function renderBlocks() {
    earnContainer.innerHTML = "";

    earnBlocks.forEach((block, index) => {
        if (!block || !block.title) return;

        const el = document.createElement("div");
        el.className = "task-card";

        el.innerHTML = `
        <div class="task-info">
            <div class="task-icon">
                ${block.icon ? `<img src="${block.icon}" class="task-icon-img">` : '★'}
            </div>
            <div class="task-text">
                <h3>${block.title}</h3>
                <p class="reward">+${block.reward || 0}</p>
            </div>
        </div>
        <div class="arrow">›</div>
        `;

        el.addEventListener("click", async () => {
            el.style.pointerEvents = "none";
            window.open(block.link, "_blank");

            const res = await fetch("/earn/complete", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    userId: uid,
                    blockId: index,
                    reward: block.reward || 0
                })
            });

            const data = await res.json();
            if (data.ok) {
                el.classList.add("completed");
                el.querySelector(".arrow").innerHTML = "✓";
                setTimeout(() => location.reload(), 500);
            }
        });

        earnContainer.appendChild(el);
    });
}
</script>
</body>
</html>