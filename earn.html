<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Notcoin Tasks UI</title>

<link rel="stylesheet" href="style2.css">

<style>
/* ===== EARN STYLE ===== */
.task-section { margin-bottom: 30px; }

.task-card {
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:14px;
    margin-bottom:12px;
    border-radius:12px;
    background:#111;
    cursor:pointer;
}

.task-card.completed {
    opacity:0.5;
    cursor:default;
}

.task-info {
    display:flex;
    align-items:center;
}

.task-icon {
    font-size:30px;
    margin-right:10px;
    width:40px;
    text-align:center;
}

.task-text h3 {
    margin:0;
    font-size:16px;
}

.task-text p {
    margin:4px 0 0;
    font-size:14px;
}

.reward { color:#0f0; }
.status { color:#aaa; }

.arrow, .check {
    font-size:20px;
}
</style>
</head>

<body>

<div class="app-container">

<header class="header">
    <a href="index.html" class="back-btn">‚Äπ Back</a>
</header>

<!-- ===== SPECIALS (STATIC) ===== -->
<section class="task-section">
    <h2 class="section-title">Specials</h2>

    <div class="task-card">
        <div class="task-info">
            <div class="task-icon">üöÄ</div>
            <div class="task-text">
                <h3>Subscription channel</h3>
                <p class="reward">+300,000 ‚óè</p>
            </div>
        </div>
        <div class="arrow">‚Ä∫</div>
    </div>

    <div class="task-card">
        <div class="task-info">
            <div class="task-icon">‚òÖ</div>
            <div class="task-text">
                <h3>Telegram Premium</h3>
                <p class="reward">+3,000,000 ‚óè</p>
            </div>
        </div>
        <div class="arrow">‚Ä∫</div>
    </div>

    <div class="task-card completed">
        <div class="task-info">
            <div class="task-icon">‚óã</div>
            <div class="task-text">
                <h3>Follow Community</h3>
                <p class="status">Completed</p>
            </div>
        </div>
        <div class="check">‚úì</div>
    </div>
</section>

<!-- ===== EARN (DYNAMIC) ===== -->
<section class="task-section">
    <h2 class="section-title">Earn</h2>
    <div id="earn-container"></div>
</section>

</div>

<script>
/* ===== GLOBAL ===== */
let earnBlocks = [];
const earnContainer = document.getElementById("earn-container");
const uid = localStorage.getItem("uid");

/* ===== LOAD USER SCORE ===== */
async function loadScore(userId) {
    try {
        const res = await fetch(`/score/${userId}`);
        const data = await res.json();
        const pointsElem = document.getElementById("points");
        if (pointsElem) pointsElem.textContent = data.score || 0;
    } catch (err) {
        console.error(err);
    }
}

/* ===== LOAD EARN BLOCKS (WITH UID) ===== */
fetch(`/earn-blocks/${uid}`)
    .then(res => res.json())
    .then(data => {
        earnBlocks = data.slice(0, 35);
        renderBlocks();
    })
    .catch(err => console.error(err));

/* ===== RENDER BLOCKS ===== */
function renderBlocks() {
    earnContainer.innerHTML = "";

    earnBlocks.forEach((block, index) => {
        if (!block || !block.title) return;

        const el = document.createElement("div");
        el.className = "task-card" + (block.completed ? " completed" : "");

        el.innerHTML = `
            <div class="task-info">
                <div class="task-icon">${block.icon || "‚òÖ"}</div>
                <div class="task-text">
                    <h3>${block.title}</h3>
                    ${
                        block.completed
                        ? `<p class="status">Completed</p>`
                        : `<p class="reward">+${block.reward || 0} ‚óè</p>`
                    }
                </div>
            </div>
            ${block.completed ? `<div class="check">‚úì</div>` : `<div class="arrow">‚Ä∫</div>`}
        `;

        /* ===== CLICK HANDLER ===== */
        if (!block.completed && block.link && uid) {
            el.addEventListener("click", async () => {
                el.style.pointerEvents = "none"; // üîí –∞–Ω—Ç–∏-—Å–ø–∞–º
                window.open(block.link, "_blank");

                try {
                    const res = await fetch("/earn/complete", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            userId: uid,
                            blockId: index,
                            reward: block.reward || 0
                        })
                    });

                    const data = await res.json();

                    if (data.already) return;

                    if (data.ok) {
                        block.completed = true;
                        renderBlocks();
                        loadScore(uid);

                        setTimeout(() => {
                            window.location.href = "index.html";
                        }, 500);
                    }
                } catch (err) {
                    console.error(err);
                }
            });
        }

        earnContainer.appendChild(el);
    });
}
</script>

</body>
</html>