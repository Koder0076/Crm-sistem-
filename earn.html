<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Notcoin Tasks UI</title>
<link rel="stylesheet" href="style2.css">
<style>
/* –°—Ç–∏–ª—å –±–ª–æ–∫—ñ–≤ —è–∫ Specials */
.task-section { margin-bottom: 30px; }
.task-card.completed .task-text p { color: gray; }
.task-info { display: flex; align-items: center; }
.task-icon { font-size: 30px; margin-right: 10px; width: 40px; text-align: center; }
.task-text h3 { margin: 0; font-size: 16px; }
.task-text p { margin: 2px 0 0 0; font-size: 14px; }
.arrow, .check { font-size: 20px; margin-left: 10px; }
</style>
</head>
<body>

<div class="app-container">
    <header class="header">
        <a href="index.html" class="back-btn">‚Äπ Back</a>
    </header>

    <!-- Specials -->
    <section class="task-section">
        <h2 class="section-title">Specials <span class="count">1/2</span></h2>

        <div class="task-card">
            <div class="task-info">
                <div class="task-icon rocket">üöÄ</div>
                <div class="task-text">
                    <h3>Subscription channel</h3>
                    <p class="reward">+300,000 <span class="coin">‚óè</span></p>
                </div>
            </div>
            <div class="arrow">‚Ä∫</div>
        </div>

        <div class="task-card">
            <div class="task-info">
                <div class="task-icon star">‚òÖ</div>
                <div class="task-text">
                    <h3>Telegram Premium</h3>
                    <p class="reward">+3,000,000 <span class="coin">‚óè</span></p>
                </div>
            </div>
            <div class="arrow">‚Ä∫</div>
        </div>

        <div class="task-card completed">
            <div class="task-info">
                <div class="task-icon circle">‚óã</div>
                <div class="task-text">
                    <h3>Follow Community</h3>
                    <p class="status">Completed</p>
                </div>
            </div>
            <div class="check">‚úì</div>
        </div>
    </section>

    <!-- Earn -->
    <section class="task-section">
        <h2 class="section-title">Earn</h2>
        <div id="earn-container"></div>
    </section>
</div>

<script>
let earnBlocks = [];
const earnContainer = document.getElementById("earn-container");
let uid = localStorage.getItem("uid");

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è score –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
async function loadScore(userId) {
    try {
        const res = await fetch(`/score/${userId}`);
        const data = await res.json();
        const pointsElem = document.getElementById("points");
        if (pointsElem) pointsElem.textContent = data.score || 0;
    } catch (err) {
        console.error(err);
    }
}

// –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è Earn-–±–ª–æ–∫—ñ–≤
fetch("/earn-blocks")
    .then(res => res.json())
    .then(data => {
        earnBlocks = data.slice(0, 35);
        renderBlocks(earnBlocks, earnContainer);
    })
    .catch(err => console.error(err));

// –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è Earn-–±–ª–æ–∫—ñ–≤
function renderBlocks(blocks, container) {
    container.innerHTML = "";

    blocks.forEach((block, index) => {
        if (!block || (!block.title && !block.reward && !block.icon && !block.link)) return;

        const el = document.createElement("div");
        el.className = "task-card" + (block.completed ? " completed" : "");

        el.innerHTML = `
            <div class="task-info">
                <div class="task-icon">${block.icon || '‚òÖ'}</div>
                <div class="task-text">
                    <h3>${block.title || ''}</h3>
                    ${
                        block.completed
                            ? '<p class="status">Completed</p>'
                            : `<p class="reward">+${block.reward || 0} <span class="coin">‚óè</span></p>`
                    }
                </div>
            </div>
            ${block.completed ? '<div class="check">‚úì</div>' : '<div class="arrow">‚Ä∫</div>'}
        `;

        // üëâ –û–ù–û–í–õ–ï–ù–ò–ô click handler (–ê–ù–¢–ò-–ê–ë–Æ–ó)
        if (!block.completed && block.link && uid) {
            el.style.cursor = "pointer";

            el.addEventListener("click", async () => {
                el.style.pointerEvents = "none"; // üîí –æ–¥—Ä–∞–∑—É –±–ª–æ–∫—É—î–º–æ –ø–æ–≤—Ç–æ—Ä–Ω–∏–π –∫–ª—ñ–∫
                window.open(block.link, "_blank");

                try {
                    const res = await fetch("/earn/complete", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            userId: uid,
                            blockId: index,
                            reward: block.reward || 0
                        })
                    });

                    const data = await res.json();

                    if (data.ok) {
                        block.completed = true;
                        renderBlocks(earnBlocks, earnContainer);
                        loadScore(uid);

                        // ‚è± –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ –Ω–∞ –≥–æ–ª–æ–≤–Ω—É
                        setTimeout(() => {
                            window.location.href = "index.html";
                        }, 500);
                    }
                } catch (err) {
                    console.error(err);
                }
            });
        }

        container.appendChild(el);
    });
}
</script>

</body>
</html>